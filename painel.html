<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROBX — Painel Administrativo de Sinais</title>
  <meta name="description" content="Painel Administrativo de Sinais da Bolsa de Valores — ROBX" />
  <style>
    :root {
      --bg: #0f1220;
      --panel: #14182a;
      --panel-2: #1a2040;
      --text: #e9ecf1;
      --muted: #a6b0c2;
      --brand: #7c5cff;
      --green: #16c784;
      --red: #ea3943;
      --yellow: #f59e0b;
      --border: #232a4a;
      --shadow: rgba(0,0,0,0.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 1200px at -10% -10%, #1b1f38 0%, transparent 55%),
                  radial-gradient(1200px 1200px at 110% -10%, #1b1f38 0%, transparent 55%),
                  var(--bg);
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(140%) blur(6px);
      background: linear-gradient(180deg, rgba(20,24,42,0.9) 0%, rgba(20,24,42,0.65) 100%);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 6px 20px var(--shadow);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .bar { display: flex; align-items: center; gap: 16px; }
    .logo {
      display: inline-flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text);
    }
    .logo-badge{ width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center;
      background: linear-gradient(135deg, var(--brand), #4b8bff); box-shadow: 0 8px 24px rgba(124,92,255,0.35);
      font-weight: 900; letter-spacing: 0.5px; }
    .logo-title{ font-weight: 800; letter-spacing: 0.6px; font-size: 18px; }
  .subtitle{ color: var(--muted); font-size: 13px; }

  /* Controls */
  .controls{ margin-left: auto; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .segmented{ display:inline-flex; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 4px; }
  .segmented button{ appearance:none; background: transparent; border:0; color: var(--muted); font-weight:800; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .segmented button[aria-pressed="true"]{ background: rgba(124,92,255,0.18); color: var(--text); box-shadow: inset 0 0 0 1px rgba(124,92,255,0.6); }
  .field{ display:flex; align-items:center; gap:8px; background: rgba(255,255,255,0.04); border:1px solid var(--border); border-radius: 10px; padding:6px 10px; }
  .field input, .field select{ background: transparent; border:0; outline:0; color: var(--text); font-weight:700; }
  .field input::placeholder{ color: var(--muted); }
  .btn{ appearance:none; background: linear-gradient(135deg, var(--brand), #4b8bff); color: white; border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 24px rgba(124,92,255,0.35); }

    /* Grid */
    main .grid{
      display: grid; gap: 16px; padding: 16px; max-width: 1200px; margin: 0 auto;
      grid-template-columns: 1.5fr 1fr; grid-auto-rows: min-content;
    }
    @media (max-width: 980px){ main .grid{ grid-template-columns: 1fr; } }

    /* Cards */
    .card{ background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 10px 30px var(--shadow); }
    .card h2{ margin: 0; font-size: 16px; font-weight: 700; letter-spacing: .4px; }
    .card .head{ display:flex; align-items:center; justify-content: space-between; padding: 14px 16px; border-bottom:1px solid var(--border); }
    .card .body{ padding: 16px; }

    /* Chart */
    #chartWrap{ height: 420px; }
    #myChart{ width: 100%; height: 100%; }

    /* Signal badge */
    .signal-badge{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius: 999px;
      font-weight: 800; letter-spacing:.6px; font-size: 14px; border:1px solid var(--border); }
    .signal-buy{ background: color-mix(in srgb, var(--green) 18%, transparent); color: var(--green); }
    .signal-sell{ background: color-mix(in srgb, var(--red) 18%, transparent); color: var(--red); }
    .signal-neutral{ background: color-mix(in srgb, var(--yellow) 18%, transparent); color: var(--yellow); }

    .kpi{ display:flex; gap: 12px; flex-wrap: wrap; margin-top: 14px; }
    .kpi .item{ flex:1 1 120px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; }
    .kpi .item .label{ color: var(--muted); font-size: 12px; }
    .kpi .item .value{ font-weight: 800; margin-top: 4px; }

    /* Table */
    table{ width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td{ padding: 10px 8px; border-bottom: 1px dashed var(--border); }
    th{ color: var(--muted); font-weight: 700; text-align: left; letter-spacing: .4px; }
    tr:last-child td{ border-bottom: none; }
    .pill{ padding: 2px 8px; border-radius: 999px; font-weight: 800; font-size: 12px; border:1px solid var(--border); }
    .pill.buy{ background: color-mix(in srgb, var(--green) 18%, transparent); color: var(--green); }
    .pill.sell{ background: color-mix(in srgb, var(--red) 18%, transparent); color: var(--red); }
    .muted{ color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="bar">
        <a class="logo" href="#" aria-label="ROBX">
          <span class="logo-badge">R</span>
          <span class="logo-title">ROBX</span>
        </a>
        <div style="height:24px; width:1px; background: var(--border);"></div>
        <div>
          <div style="font-weight:800; letter-spacing:.6px">Painel Administrativo de Sinais</div>
          <div class="subtitle">Bolsa de Valores — Operações simuladas para demonstração</div>
        </div>
        <div class="controls">
          <div class="segmented" role="group" aria-label="Seleção de intervalo">
            <button type="button" id="btn-1m" data-interval="1m" aria-pressed="true">1m</button>
            <button type="button" id="btn-5m" data-interval="5m" aria-pressed="false">5m</button>
            <button type="button" id="btn-15m" data-interval="15m" aria-pressed="false">15m</button>
          </div>
          <div class="field" title="Símbolo">
            <span class="muted">Símbolo</span>
            <input id="symbolInput" placeholder="AAPL ou PETR4" size="10" />
          </div>
          <div class="field" title="Provedor de dados">
            <span class="muted">Provedor</span>
            <select id="providerSelect">
              <option value="server">Servidor</option>
              <option value="simulated">Simulado</option>
              <option value="hgbrasil">HG Brasil</option>
              <option value="yahoo">Yahoo</option>
            </select>
          </div>
          <button class="btn" id="applyBtn" title="Aplicar alterações">Aplicar</button>
          <div class="subtitle" id="clock" title="Horário local"></div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid">
      <!-- Chart Card -->
      <article class="card" aria-label="Gráfico de Preço">
        <div class="head">
          <h2>Gráfico — Preço (simulado)</h2>
          <span class="muted" id="rangeLabel">1m</span>
        </div>
        <div class="body">
          <div id="chartWrap">
            <canvas id="myChart" aria-label="Gráfico de preço" role="img"></canvas>
          </div>
        </div>
      </article>

      <!-- Signal Card -->
      <aside class="card" aria-label="Indicador de Sinal">
        <div class="head">
          <h2>Indicador</h2>
          <span id="signalBadge" class="signal-badge signal-neutral">NEUTRO</span>
        </div>
        <div class="body">
          <div class="kpi">
            <div class="item">
              <div class="label">Preço atual</div>
              <div id="priceNow" class="value">—</div>
            </div>
            <div class="item">
              <div class="label">Variação</div>
              <div id="changeNow" class="value">—</div>
            </div>
            <div class="item">
              <div class="label">Último sinal</div>
              <div id="lastSignalAt" class="value muted">—</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- History Table -->
      <article class="card" style="grid-column: 1 / -1" aria-label="Histórico de Sinais">
        <div class="head">
          <h2>Histórico de Sinais</h2>
          <span class="muted" id="historyCount">0 registros</span>
        </div>
        <div class="body">
          <div style="overflow-x:auto">
            <table aria-label="Tabela de histórico de sinais">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Preço</th>
                  <th>Sinal</th>
                  <th>Comentário</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr><td class="muted" colspan="4">Sem registros ainda…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-3R3mB3WnH1nQn0y4kKij1U+0mX8mccKBG3Ss9zq0Zp30A7Xj0pQ8D5v8ZpX6QxJm" crossorigin="anonymous"></script>

  <script>
    // Utilities
    const fmtBRL = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const pad = (n) => String(n).padStart(2, '0');
    const fmtTime = (d) => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const fmtDateTime = (d) => `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${fmtTime(d)}`;

    // Config
    const INTERVALS = {
      '1m': { label: '1m', stepMs: 3000 },
      '5m': { label: '5m', stepMs: 6000 },
      '15m': { label: '15m', stepMs: 12000 },
    };
  let intervalKey = localStorage.getItem('robx.interval') || '1m';
  let timerId = null;
  let provider = localStorage.getItem('robx.provider') || 'server';
  let symbol = localStorage.getItem('robx.symbol') || (provider === 'hgbrasil' ? 'PETR4' : 'AAPL');
  const API_BASE = localStorage.getItem('robx.apiBase') || 'http://localhost:3000';
    let providerStatus = 'ok';

    // Clock
    function tickClock(){
      const el = document.getElementById('clock');
      if (!el) return;
      const now = new Date();
      el.textContent = fmtDateTime(now);
    }
    setInterval(tickClock, 1000); tickClock();

    // Data simulation
  const POINTS = 120;      // ~2 horas em 1m (simulado)
    const BASE = 100.0;      // preço base
    const VOL = 0.35;        // volatilidade relativa

    const labels = [];
    const prices = [];
    const signals = []; // { at: Date, price: number, kind: 'COMPRA'|'VENDA', note: string }
  const signalPoints = []; // para plotar no gráfico

    function seedData(){
      let p = BASE;
      const now = Date.now();
      for(let i=POINTS; i>0; i--){
        const t = new Date(now - i*60_000);
        p = p * (1 + (Math.random()-0.5) * VOL / 100);
        labels.push(fmtTime(t));
        prices.push(Number(p.toFixed(2)));
      }
    }
    async function seedFromServer(){
      // Busca série inicial do servidor e popula labels/prices
      try{
        const mapped = intervalKey === '1m' ? '1m' : (intervalKey === '5m' ? '5m' : '15m');
        const url = `${API_BASE}/api/series?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(mapped)}&range=1d`;
        const resp = await fetch(url);
        const data = await resp.json();
        const items = data.items || [];
        const lastN = items.slice(-POINTS);
        lastN.forEach(it => {
          const d = new Date(it.t);
          labels.push(fmtTime(d));
          prices.push(Number(it.y.toFixed(2)));
        });
        if (labels.length === 0) throw new Error('sem dados');
      } catch(e){
        console.warn('seedFromServer fallback simulado:', e);
        seedData();
      }
    }

    function sma(arr, window){
      if (arr.length < window) return null;
      let sum = 0; for (let i=arr.length-window; i<arr.length; i++) sum += arr[i];
      return sum / window;
    }

    function decideSignal(series){
      // Regras simples: média curta vs longa e inclinação
      const s8 = sma(series, 8);
      const s21 = sma(series, 21);
      if (s8 == null || s21 == null) return 'NEUTRO';
      const slope = series.at(-1) - series.at(-3);
      if (s8 > s21 && slope > 0) return 'COMPRA';
      if (s8 < s21 && slope < 0) return 'VENDA';
      return 'NEUTRO';
    }

    // Chart setup
    let chart;
    function createChart(){
      const ctx = document.getElementById('myChart');
      const gradient = ctx.getContext('2d').createLinearGradient(0,0,0,300);
      gradient.addColorStop(0, 'rgba(124,92,255,0.28)');
      gradient.addColorStop(1, 'rgba(124,92,255,0.02)');

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Preço',
              data: prices,
              borderColor: '#7c5cff',
              backgroundColor: gradient,
              fill: true,
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 0,
              pointHitRadius: 8,
            },
            {
              type: 'scatter',
              label: 'Sinais',
              data: signalPoints, // {x: label, y: price, kind}
              showLine: false,
              pointRadius: 5,
              pointHoverRadius: 6,
              pointStyle: (ctx) => ctx.raw?.kind === 'COMPRA' ? 'triangle' : 'rectRot',
              pointBackgroundColor: (ctx) => ctx.raw?.kind === 'COMPRA' ? '#16c784' : '#ea3943',
              pointBorderColor: 'rgba(0,0,0,0.4)',
              pointBorderWidth: 1.5,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  if (ctx.dataset.type === 'scatter') {
                    const k = ctx.raw?.kind || '';
                    return `${k}: ${fmtBRL(ctx.parsed.y)}`;
                  }
                  return `Preço: ${fmtBRL(ctx.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#a6b0c2' } },
            y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#a6b0c2' } },
          }
        }
      });
    }

    function updateSignalUI(kind, price, change){
      const badge = document.getElementById('signalBadge');
      badge.classList.remove('signal-buy','signal-sell','signal-neutral');
      if (kind === 'COMPRA') badge.classList.add('signal-buy');
      else if (kind === 'VENDA') badge.classList.add('signal-sell');
      else badge.classList.add('signal-neutral');
      badge.textContent = kind;

      document.getElementById('priceNow').textContent = fmtBRL(price);
      const chEl = document.getElementById('changeNow');
      const sign = change > 0 ? '+' : '';
      chEl.textContent = `${sign}${change.toFixed(2)}%`;
      chEl.style.color = change > 0 ? 'var(--green)' : (change < 0 ? 'var(--red)' : 'var(--text)');
    }

    function pushHistory(kind, price, note){
      const tbody = document.getElementById('historyBody');
      if (tbody.children.length === 1 && tbody.children[0].children[0]?.textContent?.includes('Sem registros')){
        tbody.innerHTML = '';
      }
      const tr = document.createElement('tr');
      const when = new Date();
      tr.innerHTML = `
        <td>${fmtDateTime(when)}</td>
        <td>${fmtBRL(price)}</td>
        <td><span class="pill ${kind==='COMPRA'?'buy':'sell'}">${kind}</span></td>
        <td class="muted">${note || ''}</td>`;
      tbody.prepend(tr);
      const total = document.querySelectorAll('#historyBody tr').length;
      document.getElementById('historyCount').textContent = `${total} registro${total>1?'s':''}`;
      document.getElementById('lastSignalAt').textContent = fmtTime(when);
    }

    function addSignalPoint(kind, price){
      const x = labels.at(-1);
      signalPoints.push({ x, y: price, kind });
      if (signalPoints.length > Math.floor(POINTS/2)) signalPoints.shift();
    }

    async function fetchHG(symbol, apiKey){
      try {
        const key = apiKey || localStorage.getItem('robx.hgKey') || '';
        if (!key) throw new Error('HG Brasil requer API Key');
        const url = `https://api.hgbrasil.com/finance/stock_price?key=${encodeURIComponent(key)}&symbol=${encodeURIComponent(symbol)}`;
        const resp = await fetch(url, { mode: 'cors' });
        const data = await resp.json();
        const first = Object.values(data?.results || {})[0];
        const price = Number(first?.price || first?.current_price || NaN);
        if (!isFinite(price)) throw new Error('Preço inválido');
        providerStatus = 'ok';
        return price;
      } catch (e){
        providerStatus = 'error';
        console.warn('HG Brasil erro:', e);
        return null;
      }
    }

    async function fetchYahoo(symbol, interval){
      try {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=${encodeURIComponent(interval)}&range=1d`;
        const resp = await fetch(url, { mode: 'cors' });
        const data = await resp.json();
        const res = data?.chart?.result?.[0];
        const closeArr = res?.indicators?.quote?.[0]?.close || [];
        const last = closeArr.filter(x => x != null).at(-1);
        if (!isFinite(last)) throw new Error('Sem dado');
        providerStatus = 'ok';
        return Number(last);
      } catch (e){
        providerStatus = 'error';
        console.warn('Yahoo erro/CORS:', e);
        return null;
      }
    }

    async function step(){
      let next;
      const now = new Date();
      if (provider === 'server'){
        try{
          const url = `${API_BASE}/api/quote?symbol=${encodeURIComponent(symbol)}`;
          const resp = await fetch(url);
          const data = await resp.json();
          next = Number(data?.price);
        }catch(e){ next = NaN; }
      } else if (provider === 'hgbrasil'){
        next = await fetchHG(symbol);
      } else if (provider === 'yahoo'){
        const i = intervalKey === '1m' ? '1m' : (intervalKey === '5m' ? '5m' : '15m');
        next = await fetchYahoo(symbol, i);
      }

      if (!isFinite(next)){
        // Fallback para simulado
        const last = prices.at(-1);
        const drift = (Math.random()-0.5) * VOL; // em %
        next = Number((last * (1 + drift/100)).toFixed(2));
      }

      labels.push(fmtTime(now));
      prices.push(next);
      labels.shift();
      prices.shift();

      // Decide sinal atual e atualizar UI
      const kind = decideSignal(prices);
      const changePct = ((next - prices.at(-2)) / prices.at(-2)) * 100;
      updateSignalUI(kind, next, changePct);

      const prevKind = signals.at(-1)?.kind;
      if (kind !== 'NEUTRO' && kind !== prevKind){
        signals.push({ at: new Date(), price: next, kind, note: changePct > 0 ? 'Momentum positivo' : 'Pressão vendedora' });
        pushHistory(kind, next, signals.at(-1).note);
        addSignalPoint(kind, next);
      }

      // Atualiza chart
      chart.update('none');
    }

    // Initialize
    async function resetData(){
      labels.length = 0; prices.length = 0; signals.length = 0; signalPoints.length = 0;
      if (provider === 'server') {
        await seedFromServer();
      } else {
        seedData();
      }
      if (chart){
        chart.data.labels = labels;
        chart.data.datasets[0].data = prices;
        chart.data.datasets[1].data = signalPoints;
        chart.update();
      }
      const initKind = decideSignal(prices);
      updateSignalUI(initKind, prices.at(-1), ((prices.at(-1)-prices.at(-2))/prices.at(-2))*100);
    }

    function startLoop(){
      if (timerId) clearInterval(timerId);
      const stepMs = INTERVALS[intervalKey].stepMs;
      document.getElementById('rangeLabel').textContent = INTERVALS[intervalKey].label;
      timerId = setInterval(step, stepMs);
    }

    function bindControls(){
      // Interval buttons
      const btns = [document.getElementById('btn-1m'), document.getElementById('btn-5m'), document.getElementById('btn-15m')];
      function setPressed(){
        btns.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.interval === intervalKey)));
      }
      btns.forEach(b => b.addEventListener('click', async () => {
        intervalKey = b.dataset.interval;
        localStorage.setItem('robx.interval', intervalKey);
        setPressed();
        await resetData();
        startLoop();
      }));
      setPressed();

      // Provider + symbol
      const sel = document.getElementById('providerSelect');
      const sym = document.getElementById('symbolInput');
      const apply = document.getElementById('applyBtn');
      sel.value = provider;
      sym.value = symbol;
      apply.addEventListener('click', async () => {
        provider = sel.value;
        symbol = (sym.value || '').trim().toUpperCase() || (provider === 'hgbrasil' ? 'PETR4' : 'AAPL');
        localStorage.setItem('robx.provider', provider);
        localStorage.setItem('robx.symbol', symbol);
        await resetData();
        startLoop();
      });
    }

    // Bootstrap
    (async function(){
      if (provider === 'server') {
        await seedFromServer();
      } else {
        seedData();
      }
      createChart();
      bindControls();
      await resetData();
      startLoop();
    })();
  </script>
</body>
</html>
